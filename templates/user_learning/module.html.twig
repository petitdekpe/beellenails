{% extends 'base.html.twig' %}

{% block title %}{{ moduleProgress.module.title }} - {{ enrollment.formation.nom }}{% endblock %}

{% block body %}
<div class="min-h-screen bg-gray-50">
    <div class="pt-16 md:pt-20"></div>
    
    <div class="px-4 py-6 sm:px-6 lg:px-8 max-w-7xl mx-auto">
        <div class="flex flex-col lg:flex-row gap-8">
            
            <!-- Sidebar -->
            <div class="lg:w-80">
                {% include 'user_learning/_sidebar.html.twig' %}
            </div>

            <!-- Main Content -->
            <div class="flex-1 space-y-8">
                
                <!-- Module Header -->
                <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex items-center justify-between mb-4">
                            <a href="{{ path('app_user_learning_formation_detail', {id: enrollment.id}) }}" 
                               class="inline-flex items-center text-sm text-gray-500 hover:text-gray-700">
                                ‚Üê Retour √† {{ enrollment.formation.nom }}
                            </a>
                            
                            <div class="flex items-center space-x-2">
                                <span class="inline-flex items-center justify-center w-8 h-8 bg-pink-100 text-pink-600 rounded-full text-sm font-semibold">
                                    {{ moduleProgress.module.position }}
                                </span>
                                <span class="text-sm text-gray-500">sur {{ totalModules }}</span>
                            </div>
                        </div>
                        
                        <h1 class="text-2xl font-bold text-gray-900 mb-2">{{ moduleProgress.module.title }}</h1>
                        
                        {% if moduleProgress.module.description %}
                            <p class="text-gray-600 mb-4">{{ moduleProgress.module.description }}</p>
                        {% endif %}
                        
                        <div class="flex flex-wrap gap-3">
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800">
                                ‚è±Ô∏è {{ moduleProgress.module.formattedDuration }}
                            </span>
                            
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium 
                                {% if moduleProgress.status == 'completed' %}bg-green-100 text-green-800{% 
                                elseif moduleProgress.status == 'in_progress' %}bg-blue-100 text-blue-800{% 
                                else %}bg-gray-100 text-gray-800{% endif %}">
                                {% if moduleProgress.status == 'completed' %}‚úÖ Termin√©{% 
                                elseif moduleProgress.status == 'in_progress' %}‚ñ∂Ô∏è En cours{% 
                                else %}‚≠ï Non commenc√©{% endif %}
                            </span>
                            
                            {% if moduleProgress.timeSpent > 0 %}
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-purple-100 text-purple-800">
                                    üìä {{ moduleProgress.formattedTimeSpent }} √©tudi√©es
                                </span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Progress Bar -->
                    {% if moduleProgress.status == 'in_progress' %}
                    <div class="px-6 py-4 bg-gray-50">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-medium text-gray-700">Progression du module</span>
                            <span class="text-sm font-medium text-gray-900">{{ moduleProgress.completionPercentage }}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" 
                                 style="width: {{ moduleProgress.completionPercentage }}%"></div>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- Video Section -->
                {% if moduleProgress.module.videoUrl %}
                <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                    <div class="aspect-w-16 aspect-h-9 bg-black">
                        <div id="youtube-player" class="w-full h-full"></div>
                    </div>
                    
                    <div class="p-6">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <button id="play-pause-btn" 
                                        class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-pink-600 hover:bg-pink-700">
                                    ‚ñ∂Ô∏è Lecture
                                </button>
                                
                                {% if moduleProgress.videoPosition > 0 %}
                                    <span class="text-sm text-gray-600">
                                        Reprendre √† {{ moduleProgress.formattedVideoPosition }}
                                    </span>
                                {% endif %}
                            </div>
                            
                            <div class="flex items-center space-x-2">
                                {% if moduleProgress.status != 'completed' %}
                                    <button id="mark-complete-btn" 
                                            class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                        ‚úÖ Marquer comme termin√©
                                    </button>
                                {% endif %}
                                
                                <div id="video-controls" class="text-sm text-gray-500">
                                    <span id="current-time">00:00</span> / <span id="duration">{{ moduleProgress.module.formattedDuration }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Module Content -->
                {% if moduleProgress.module.content %}
                <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-bold text-gray-900">üìù Contenu du module</h3>
                    </div>
                    <div class="p-6 prose max-w-none">
                        {{ moduleProgress.module.content|raw }}
                    </div>
                </div>
                {% endif %}

                <!-- Navigation -->
                <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                    <div class="p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                {% if previousModule %}
                                    <a href="{{ path('app_user_learning_module', {enrollmentId: enrollment.id, moduleId: previousModule.id}) }}" 
                                       class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                        ‚Üê Module pr√©c√©dent
                                    </a>
                                {% endif %}
                            </div>
                            
                            <div class="text-center">
                                <p class="text-sm text-gray-600 mb-2">Module {{ moduleProgress.module.position }} sur {{ totalModules }}</p>
                                <div class="w-32 bg-gray-200 rounded-full h-2">
                                    <div class="bg-pink-600 h-2 rounded-full" 
                                         style="width: {{ (moduleProgress.module.position / totalModules * 100) }}%"></div>
                                </div>
                            </div>
                            
                            <div>
                                {% if nextModule %}
                                    <a href="{{ path('app_user_learning_module', {enrollmentId: enrollment.id, moduleId: nextModule.id}) }}" 
                                       class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-pink-600 hover:bg-pink-700">
                                        Module suivant ‚Üí
                                    </a>
                                {% else %}
                                    {% if enrollment.progressPercentage == 100 %}
                                        <a href="{{ path('app_user_learning_certificate', {enrollmentId: enrollment.id}) }}" 
                                           class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700">
                                            üìú Obtenir le certificat
                                        </a>
                                    {% else %}
                                        <a href="{{ path('app_user_learning_formation_detail', {id: enrollment.id}) }}" 
                                           class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                            Retour √† la formation
                                        </a>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- YouTube API Script -->
<script src="https://www.youtube.com/iframe_api"></script>
<script>
    let player;
    let progressSaveInterval;
    let enrollmentId = {{ enrollment.id }};
    let moduleId = {{ moduleProgress.module.id }};
    let startPosition = {{ moduleProgress.videoPosition }};
    let isCompleted = {{ moduleProgress.status == 'completed' ? 'true' : 'false' }};

    // YouTube Player API
    function onYouTubeIframeAPIReady() {
        player = new YT.Player('youtube-player', {
            height: '100%',
            width: '100%',
            videoId: '{{ moduleProgress.module.youtubeId }}',
            playerVars: {
                'autoplay': 0,
                'controls': 1,
                'start': startPosition
            },
            events: {
                'onReady': onPlayerReady,
                'onStateChange': onPlayerStateChange
            }
        });
    }

    function onPlayerReady(event) {
        // Start saving progress every 10 seconds when video starts
        updateTimeDisplay();
        
        // Resume from saved position if exists
        if (startPosition > 0) {
            player.seekTo(startPosition, true);
        }
    }

    function onPlayerStateChange(event) {
        if (event.data == YT.PlayerState.PLAYING) {
            document.getElementById('play-pause-btn').innerHTML = '‚è∏Ô∏è Pause';
            startProgressTracking();
        } else if (event.data == YT.PlayerState.PAUSED) {
            document.getElementById('play-pause-btn').innerHTML = '‚ñ∂Ô∏è Lecture';
            stopProgressTracking();
            saveProgress();
        } else if (event.data == YT.PlayerState.ENDED) {
            stopProgressTracking();
            if (!isCompleted) {
                markModuleComplete();
            }
        }
    }

    function startProgressTracking() {
        if (progressSaveInterval) {
            clearInterval(progressSaveInterval);
        }
        
        progressSaveInterval = setInterval(() => {
            saveProgress();
            updateTimeDisplay();
            checkAutoCompletion();
        }, 10000); // Save every 10 seconds
    }

    function stopProgressTracking() {
        if (progressSaveInterval) {
            clearInterval(progressSaveInterval);
        }
    }

    function saveProgress() {
        if (!player || !player.getCurrentTime) return;
        
        let currentTime = Math.floor(player.getCurrentTime());
        let duration = Math.floor(player.getDuration());
        
        fetch(`/user-learning/api/progress/${enrollmentId}/${moduleId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
                videoPosition: currentTime,
                timeSpent: currentTime - startPosition + {{ moduleProgress.timeSpent }}
            })
        }).catch(error => console.error('Error saving progress:', error));
    }

    function checkAutoCompletion() {
        if (isCompleted || !player) return;
        
        let currentTime = player.getCurrentTime();
        let duration = player.getDuration();
        
        if (duration > 0 && currentTime / duration >= 0.95) {
            markModuleComplete();
        }
    }

    function markModuleComplete() {
        if (isCompleted) return;
        
        fetch(`/user-learning/api/complete/${enrollmentId}/${moduleId}`, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        }).then(response => response.json())
        .then(data => {
            if (data.success) {
                isCompleted = true;
                location.reload(); // Refresh to update UI
            }
        }).catch(error => console.error('Error marking complete:', error));
    }

    function updateTimeDisplay() {
        if (!player || !player.getCurrentTime) return;
        
        let currentTime = Math.floor(player.getCurrentTime());
        let duration = Math.floor(player.getDuration());
        
        document.getElementById('current-time').textContent = formatTime(currentTime);
        if (duration > 0) {
            document.getElementById('duration').textContent = formatTime(duration);
        }
    }

    function formatTime(seconds) {
        let mins = Math.floor(seconds / 60);
        let secs = seconds % 60;
        return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    // Event listeners
    document.getElementById('play-pause-btn').addEventListener('click', function() {
        if (player.getPlayerState() === YT.PlayerState.PLAYING) {
            player.pauseVideo();
        } else {
            player.playVideo();
        }
    });

    {% if moduleProgress.status != 'completed' %}
    document.getElementById('mark-complete-btn').addEventListener('click', function() {
        if (confirm('√ätes-vous s√ªr de vouloir marquer ce module comme termin√© ?')) {
            markModuleComplete();
        }
    });
    {% endif %}

    // Save progress when leaving page
    window.addEventListener('beforeunload', function() {
        if (player && player.getCurrentTime) {
            navigator.sendBeacon(`/user-learning/api/progress/${enrollmentId}/${moduleId}`, 
                JSON.stringify({
                    videoPosition: Math.floor(player.getCurrentTime()),
                    timeSpent: Math.floor(player.getCurrentTime()) - startPosition + {{ moduleProgress.timeSpent }}
                })
            );
        }
    });
</script>
{% endblock %}