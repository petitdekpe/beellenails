{% extends 'base.html.twig' %}

{% block title %}Dashboard - Vue d'ensemble{% endblock %}

{% block body %}
<div class="min-h-screen bg-gray-50">
    <div class="flex">
        <!-- Sidebar -->
        {% include '_sidebar.html.twig' %}
        
        <!-- Main Content -->
        <div class="flex-1 {% if is_granted('ROLE_ADMIN') %}lg:ml-8{% endif %}">
            <div class="px-4 py-6 sm:px-6 lg:px-8">
                <!-- Header int√©gr√© -->
                <div class="mb-6">
                    <h1 class="text-2xl font-bold text-gray-900">Vue d'ensemble</h1>
                    <p class="text-sm text-gray-600">{{ period_label }}</p>
                </div>
                <!-- Formulaire de s√©lection de p√©riode -->
                <div class="bg-white rounded-lg shadow mb-6">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h2 class="text-lg font-medium text-gray-900">S√©lectionner une p√©riode</h2>
                    </div>
                    <div class="px-6 py-4">
                        {{ form_start(form, {'attr': {'class': 'space-y-4', 'id': 'period-form'}}) }}
                        <div class="w-full md:w-1/3">
                            {{ form_row(form.period_type) }}
                        </div>
                        <button type="submit" class="bg-pink-600 hover:bg-pink-700 text-white font-medium py-2 px-4 rounded-lg">
                            Actualiser
                        </button>
                        {{ form_end(form) }}
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    
                    <!-- 1. Rendez-vous de la p√©riode -->
                    <div class="bg-white rounded-lg shadow">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h3 class="text-lg font-medium text-gray-900">
                                üìÖ Rendez-vous de la p√©riode ({{ appointments|length }})
                            </h3>
                        </div>
                        <div class="px-6 py-4 max-h-64 overflow-y-auto">
                            {% if appointments|length > 0 %}
                                <div class="space-y-3">
                                    {% for rdv in appointments %}
                                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                            <div>
                                                <p class="font-medium text-gray-900">{{ rdv.user.fullName }}</p>
                                                <p class="text-sm text-gray-600">{{ rdv.prestation.title }}</p>
                                                <p class="text-xs text-gray-500">{{ rdv.status }}</p>
                                            </div>
                                            <div class="text-right">
                                                <p class="text-sm font-medium text-gray-900">{{ rdv.day|date('d/m') }}</p>
                                                <p class="text-xs text-gray-600">{{ rdv.creneau.startTime|date('H:i') }}</p>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <p class="text-gray-500 italic">Aucun rendez-vous pour cette p√©riode</p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- 2. Rendez-vous cr√©√©s cette p√©riode -->
                    <div class="bg-white rounded-lg shadow">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h3 class="text-lg font-medium text-gray-900">
                                ‚ûï Rendez-vous cr√©√©s cette p√©riode ({{ appointments_created|length }})
                            </h3>
                        </div>
                        <div class="px-6 py-4 max-h-64 overflow-y-auto">
                            {% if appointments_created|length > 0 %}
                                <div class="space-y-3">
                                    {% for rdv in appointments_created %}
                                        {% set status_classes = {
                                            'Rendez-vous pris': 'bg-blue-50 text-blue-700',
                                            'Rendez-vous confirm√©': 'bg-green-50 text-green-700',
                                            'Annul√©': 'bg-red-50 text-red-700',
                                            'Report√©': 'bg-orange-50 text-orange-700',
                                            'Tentative √©chou√©': 'bg-red-100 text-red-800',
                                            'Tentative √©chou√©e': 'bg-red-100 text-red-800',
                                            '√âchec du paiement': 'bg-red-200 text-red-900',
                                            'Paiement en attente': 'bg-yellow-50 text-yellow-700',
                                            'Cong√©': 'bg-purple-50 text-purple-700'
                                        } %}
                                        {% set bg_class = status_classes[rdv.status] ?: 'bg-gray-50' %}
                                        <div class="flex items-center justify-between p-3 {{ bg_class|split(' ')[0] }} rounded-lg">
                                            <div>
                                                <p class="font-medium text-gray-900">{{ rdv.user.fullName }}</p>
                                                <p class="text-sm text-gray-600">{{ rdv.prestation.title }}</p>
                                                <p class="text-xs {{ bg_class|split(' ')[1] ?: 'text-gray-600' }} font-medium">{{ rdv.status }}</p>
                                                <p class="text-xs text-gray-500">Cr√©√© le {{ rdv.createdAt|date('d/m/Y H:i') }}</p>
                                            </div>
                                            <div class="text-right">
                                                <p class="text-sm font-medium text-gray-900">{{ rdv.day|date('d/m') }}</p>
                                                <p class="text-xs text-gray-600">{{ rdv.creneau.startTime|date('H:i') }}</p>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <p class="text-gray-500 italic">Aucun rendez-vous cr√©√© cette p√©riode</p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- 3. Rendez-vous annul√©s -->
                    <div class="bg-white rounded-lg shadow">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h3 class="text-lg font-medium text-gray-900">
                                ‚ùå Rendez-vous annul√©s ({{ cancelled_appointments|length }})
                            </h3>
                        </div>
                        <div class="px-6 py-4 max-h-64 overflow-y-auto">
                            {% if cancelled_appointments|length > 0 %}
                                <div class="space-y-3">
                                    {% for rdv in cancelled_appointments %}
                                        <div class="flex items-center justify-between p-3 bg-red-50 rounded-lg">
                                            <div>
                                                <p class="font-medium text-gray-900">{{ rdv.user.fullName }}</p>
                                                <p class="text-sm text-gray-600">{{ rdv.prestation.title }}</p>
                                            </div>
                                            <div class="text-right">
                                                <p class="text-sm font-medium text-red-600">{{ rdv.day|date('d/m') }}</p>
                                                <p class="text-xs text-red-500">{{ rdv.creneau.startTime|date('H:i') }}</p>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <p class="text-gray-500 italic">Aucun rendez-vous annul√©</p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- 4. Rendez-vous report√©s -->
                    <div class="bg-white rounded-lg shadow">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h3 class="text-lg font-medium text-gray-900">
                                üîÑ Rendez-vous report√©s ({{ rescheduled_appointments|length }})
                            </h3>
                        </div>
                        <div class="px-6 py-4 max-h-64 overflow-y-auto">
                            {% if rescheduled_appointments|length > 0 %}
                                <div class="space-y-3">
                                    {% for rdv in rescheduled_appointments %}
                                        <div class="flex items-center justify-between p-3 bg-orange-50 rounded-lg">
                                            <div>
                                                <p class="font-medium text-gray-900">{{ rdv.user.fullName }}</p>
                                                <p class="text-sm text-gray-600">{{ rdv.prestation.title }}</p>
                                                <p class="text-xs text-orange-600">Modifi√© le {{ rdv.updatedAt|date('d/m/Y H:i') }}</p>
                                            </div>
                                            <div class="text-right">
                                                <p class="text-sm font-medium text-orange-600">{{ rdv.day|date('d/m') }}</p>
                                                <p class="text-xs text-orange-500">{{ rdv.creneau.startTime|date('H:i') }}</p>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <p class="text-gray-500 italic">Aucun rendez-vous report√©</p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- 5. Nouveaux clients -->
                    <div class="bg-white rounded-lg shadow">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h3 class="text-lg font-medium text-gray-900">
                                üë• Nouveaux clients ({{ new_clients|length }})
                            </h3>
                        </div>
                        <div class="px-6 py-4 max-h-64 overflow-y-auto">
                            {% if new_clients|length > 0 %}
                                <div class="space-y-3">
                                    {% for client in new_clients %}
                                        <div class="flex items-center justify-between p-3 bg-blue-50 rounded-lg">
                                            <div>
                                                <p class="font-medium text-gray-900">
                                                    {% if client %}
                                                        {{ client.Nom }} {{ client.Prenom }}
                                                    {% else %}
                                                        Client supprim√©
                                                    {% endif %}
                                                </p>
                                                <p class="text-sm text-gray-600">
                                                    {% if client %}
                                                        {{ client.email }}
                                                    {% else %}
                                                        N/A
                                                    {% endif %}
                                                </p>
                                            </div>
                                            <span class="text-xs text-blue-600 font-medium">
                                                Nouveau client
                                            </span>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <p class="text-gray-500 italic">Aucun nouveau client cette p√©riode</p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- 6. Cr√©neaux libres -->
                    <div class="bg-white rounded-lg shadow">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h3 class="text-lg font-medium text-gray-900">
                                üïí Cr√©neaux libres ({{ available_slots|length }})
                            </h3>
                        </div>
                        <div class="px-6 py-4 max-h-64 overflow-y-auto">
                            {% if available_slots|length > 0 %}
                                <div class="space-y-2">
                                    {% for slot in available_slots %}
                                        <div class="flex items-center justify-between p-2 bg-green-50 rounded">
                                            <span class="text-sm font-medium text-gray-900">
                                                {{ slot.date|date('D d/m') }}
                                            </span>
                                            <span class="text-sm text-green-700">
                                                {{ slot.creneau.startTime|date('H:i') }} - {{ slot.creneau.endTime|date('H:i') }}
                                            </span>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <p class="text-gray-500 italic">Aucun cr√©neau libre pour cette p√©riode</p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- 7. Recette de la p√©riode -->
                <div class="mt-6">
                    <div class="bg-white rounded-lg shadow">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h3 class="text-lg font-medium text-gray-900">üí∞ Recette de la p√©riode</h3>
                        </div>
                        <div class="px-6 py-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="text-center">
                                    <div class="text-3xl font-bold text-green-600">{{ total_revenue|number_format(0, ',', ' ') }} FCFA</div>
                                    <div class="text-sm text-gray-600">{{ payments|length }} paiement(s) confirm√©(s)</div>
                                </div>
                                <div class="max-h-40 overflow-y-auto">
                                    {% if payments|length > 0 %}
                                        <div class="space-y-2">
                                            {% for payment in payments %}
                                                <div class="flex items-center justify-between p-2 bg-green-50 rounded text-sm">
                                                    <span>
                                                        {% if payment.customer %}
                                                            {{ payment.customer.fullName }}
                                                        {% else %}
                                                            Client supprim√©
                                                        {% endif %}
                                                    </span>
                                                    <span class="font-medium">{{ payment.rendezvous.totalCost|number_format(0, ',', ' ') }} FCFA</span>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Soumission automatique du formulaire lors du changement de p√©riode
document.getElementById('period-form').addEventListener('change', function(e) {
    this.submit();
});
</script>
{% endblock %}