{% extends 'base.html.twig' %}

{% block title %}Dashboard - Transactions{% endblock %}

{% block body %}
<div class="min-h-screen bg-gray-50">
    <div class="flex">
        <!-- Sidebar -->
        {% include '_sidebar.html.twig' %}
        
        <!-- Main Content -->
        <div class="flex-1 {% if is_granted('ROLE_ADMIN') %}lg:ml-8{% endif %}">
            <div class="px-4 py-6 sm:px-6 lg:px-8">
                <!-- Header -->
                <div class="mb-6">
                    <h1 class="text-2xl font-bold text-gray-900">Gestion des transactions</h1>
                    <p class="text-sm text-gray-600">{{ payments.getTotalItemCount }} transaction(s) au total</p>
                </div>

                <!-- Filtres -->
                <div class="bg-white rounded-lg shadow mb-6">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h2 class="text-lg font-medium text-gray-900">Filtrer les transactions</h2>
                    </div>
                    <div class="px-6 py-4">
                        <form method="GET" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <!-- Filtre Provider -->
                            <div>
                                <label for="provider" class="block text-sm font-medium text-gray-700 mb-1">Provider de paiement</label>
                                <select name="provider" id="provider" class="block w-full rounded-lg border border-gray-300 px-3 py-2 focus:outline-none focus:ring-1 focus:ring-pink-500 focus:border-pink-500">
                                    <option value="all" {% if not provider or provider == 'all' %}selected{% endif %}>Tous les providers</option>
                                    <option value="fedapay" {% if provider == 'fedapay' %}selected{% endif %}>FedaPay</option>
                                    <option value="feexpay" {% if provider == 'feexpay' %}selected{% endif %}>FeexPay</option>
                                </select>
                            </div>
                            
                            <!-- Date de début -->
                            <div>
                                <label for="date_from" class="block text-sm font-medium text-gray-700 mb-1">Date de début</label>
                                <input type="date" name="date_from" id="date_from" value="{{ date_from }}" class="block w-full rounded-lg border border-gray-300 px-3 py-2 focus:outline-none focus:ring-1 focus:ring-pink-500 focus:border-pink-500">
                            </div>
                            
                            <!-- Date de fin -->
                            <div>
                                <label for="date_to" class="block text-sm font-medium text-gray-700 mb-1">Date de fin</label>
                                <input type="date" name="date_to" id="date_to" value="{{ date_to }}" class="block w-full rounded-lg border border-gray-300 px-3 py-2 focus:outline-none focus:ring-1 focus:ring-pink-500 focus:border-pink-500">
                            </div>
                            
                            <!-- Boutons -->
                            <div class="md:col-span-3 flex gap-2">
                                <button type="submit" class="bg-pink-600 hover:bg-pink-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                                    Filtrer
                                </button>
                                <a href="{{ path('app_dashboard_transactions') }}" class="bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                                    Réinitialiser
                                </a>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Liste des transactions -->
                <div class="bg-white rounded-lg shadow">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-medium text-gray-900">
                            💳 Liste des transactions
                            {% if provider and provider != 'all' %}
                                <span class="text-sm font-normal text-gray-500">({{ provider|upper }})</span>
                            {% endif %}
                        </h3>
                    </div>
                    <div class="overflow-hidden">
                        {% if payments|length > 0 %}
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-pink-50">
                                        <tr>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-pink-600 uppercase tracking-wider">
                                                Transaction
                                            </th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-pink-600 uppercase tracking-wider">
                                                Client
                                            </th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-pink-600 uppercase tracking-wider">
                                                Montant
                                            </th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-pink-600 uppercase tracking-wider">
                                                Statut
                                            </th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-pink-600 uppercase tracking-wider">
                                                Provider
                                            </th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-pink-600 uppercase tracking-wider">
                                                Date
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        {% for payment in payments %}
                                            <tr class="hover:bg-gray-50 transition-colors">
                                                <td class="px-6 py-4">
                                                    <div>
                                                        <div class="text-sm font-medium text-gray-900">
                                                            {{ payment.reference ?: payment.transactionID ?: 'N/A' }}
                                                        </div>
                                                        {% if payment.description %}
                                                            <div class="text-sm text-gray-500">{{ payment.description }}</div>
                                                        {% endif %}
                                                        <div class="text-xs text-gray-400">{{ payment.phoneNumber }}</div>
                                                    </div>
                                                </td>
                                                <td class="px-6 py-4">
                                                    <div class="flex items-center">
                                                        <div class="flex-shrink-0 h-8 w-8">
                                                            <div class="h-8 w-8 rounded-full bg-gray-100 flex items-center justify-center">
                                                                <span class="text-xs font-medium text-gray-600">
                                                                    {% if payment.customer %}
                                                                        {{ payment.customer.Prenom|slice(0, 1)|upper }}{{ payment.customer.Nom|slice(0, 1)|upper }}
                                                                    {% else %}
                                                                        N/A
                                                                    {% endif %}
                                                                </span>
                                                            </div>
                                                        </div>
                                                        <div class="ml-3">
                                                            <div class="text-sm font-medium text-gray-900">
                                                                {% if payment.customer %}
                                                                    {{ payment.customer.fullName }}
                                                                {% else %}
                                                                    Client supprimé
                                                                {% endif %}
                                                            </div>
                                                            <div class="text-sm text-gray-500">
                                                                {% if payment.customer %}
                                                                    {{ payment.customer.email }}
                                                                {% else %}
                                                                    N/A
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <div class="text-sm font-semibold text-gray-900">
                                                        {{ payment.amount|number_format(0, ',', ' ') }} {{ payment.currency }}
                                                    </div>
                                                    {% if payment.fees %}
                                                        <div class="text-xs text-gray-500">Frais: {{ payment.fees }} {{ payment.currency }}</div>
                                                    {% endif %}
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    {% set status_colors = {
                                                        'pending': 'bg-yellow-100 text-yellow-800',
                                                        'approved': 'bg-green-100 text-green-800',
                                                        'successful': 'bg-green-100 text-green-800',
                                                        'declined': 'bg-red-100 text-red-800',
                                                        'failed': 'bg-red-100 text-red-800',
                                                        'canceled': 'bg-gray-100 text-gray-800',
                                                        'refunded': 'bg-blue-100 text-blue-800'
                                                    } %}
                                                    {% set status_class = status_colors[payment.status] ?: 'bg-gray-100 text-gray-800' %}
                                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {{ status_class }}">
                                                        {{ constant('App\\Entity\\Payment::STATUS_LABELS')[payment.status] ?: payment.status|title }}
                                                    </span>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    {% if payment.provider == 'fedapay' %}
                                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                                            🏦 FedaPay
                                                        </span>
                                                    {% elseif payment.provider == 'feexpay' %}
                                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                                                            💸 FeexPay
                                                        </span>
                                                    {% else %}
                                                        <span class="text-sm text-gray-500">{{ payment.provider ?: 'N/A' }}</span>
                                                    {% endif %}
                                                    {% if payment.mode %}
                                                        <div class="text-xs text-gray-500 mt-1">{{ payment.mode|upper }}</div>
                                                    {% endif %}
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <div class="text-sm text-gray-900">{{ payment.createdAt|date('d/m/Y') }}</div>
                                                    <div class="text-xs text-gray-500">{{ payment.createdAt|date('H:i') }}</div>
                                                    {% if payment.updatedAt and payment.updatedAt != payment.createdAt %}
                                                        <div class="text-xs text-blue-600">Mis à jour: {{ payment.updatedAt|date('d/m H:i') }}</div>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Pagination -->
                            {% if payments.getTotalItemCount > 0 %}
                                <div class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6">
                                    <div class="flex-1 flex justify-between sm:hidden">
                                        {% if payments.getCurrentPageNumber > 1 %}
                                            <a href="{{ path('app_dashboard_transactions', app.request.query.all|merge({'page': payments.getCurrentPageNumber - 1})) }}" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                                Précédent
                                            </a>
                                        {% endif %}
                                        {% if payments.getCurrentPageNumber < payments.getPageCount %}
                                            <a href="{{ path('app_dashboard_transactions', app.request.query.all|merge({'page': payments.getCurrentPageNumber + 1})) }}" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                                Suivant
                                            </a>
                                        {% endif %}
                                    </div>
                                    <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                                        <div>
                                            {% set itemsPerPage = payments.getItemNumberPerPage %}
                                            {% set currentPage = payments.getCurrentPageNumber %}
                                            {% set totalItems = payments.getTotalItemCount %}
                                            {% set startItem = ((currentPage - 1) * itemsPerPage) + 1 %}
                                            {% set endItem = (currentPage * itemsPerPage) > totalItems ? totalItems : (currentPage * itemsPerPage) %}
                                            
                                            <p class="text-sm text-gray-700">
                                                Affichage de
                                                <span class="font-medium">{{ startItem }}</span>
                                                à
                                                <span class="font-medium">{{ endItem }}</span>
                                                sur
                                                <span class="font-medium">{{ totalItems }}</span>
                                                résultats
                                            </p>
                                        </div>
                                        <div>
                                            <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                                                {% if payments.getCurrentPageNumber > 1 %}
                                                    <a href="{{ path('app_dashboard_transactions', app.request.query.all|merge({'page': payments.getCurrentPageNumber - 1})) }}" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                                        <span class="sr-only">Précédent</span>
                                                        <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                                            <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                                                        </svg>
                                                    </a>
                                                {% endif %}

                                                {% set startPage = payments.getCurrentPageNumber - 2 %}
                                                {% set endPage = payments.getCurrentPageNumber + 2 %}
                                                {% if startPage < 1 %}
                                                    {% set startPage = 1 %}
                                                {% endif %}
                                                {% if endPage > payments.getPageCount %}
                                                    {% set endPage = payments.getPageCount %}
                                                {% endif %}

                                                {% for page in startPage..endPage %}
                                                    {% if page == payments.getCurrentPageNumber %}
                                                        <span class="bg-pink-50 border-pink-500 text-pink-600 relative inline-flex items-center px-4 py-2 border text-sm font-medium">
                                                            {{ page }}
                                                        </span>
                                                    {% else %}
                                                        <a href="{{ path('app_dashboard_transactions', app.request.query.all|merge({'page': page})) }}" class="bg-white border-gray-300 text-gray-500 hover:bg-gray-50 relative inline-flex items-center px-4 py-2 border text-sm font-medium">
                                                            {{ page }}
                                                        </a>
                                                    {% endif %}
                                                {% endfor %}

                                                {% if payments.getCurrentPageNumber < payments.getPageCount %}
                                                    <a href="{{ path('app_dashboard_transactions', app.request.query.all|merge({'page': payments.getCurrentPageNumber + 1})) }}" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                                        <span class="sr-only">Suivant</span>
                                                        <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                                            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                                                        </svg>
                                                    </a>
                                                {% endif %}
                                            </nav>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                        {% else %}
                            <div class="px-6 py-12 text-center">
                                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
                                </svg>
                                <h3 class="mt-2 text-sm font-medium text-gray-900">Aucune transaction trouvée</h3>
                                <p class="mt-1 text-sm text-gray-500">
                                    {% if provider or date_from or date_to %}
                                        Essayez de modifier vos filtres.
                                    {% else %}
                                        Aucune transaction n'a encore été effectuée.
                                    {% endif %}
                                </p>
                                {% if provider or date_from or date_to %}
                                    <div class="mt-6">
                                        <a href="{{ path('app_dashboard_transactions') }}" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-pink-600 hover:bg-pink-700">
                                            Réinitialiser les filtres
                                        </a>
                                    </div>
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
