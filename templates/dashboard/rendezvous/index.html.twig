<section class="bg-gray-50 py-3 sm:py-5">
	<div class="mx-auto max-w-screen-xl px-2">
		<div class="bg-white shadow-md sm:rounded-lg overflow-hidden">
			<div
				class="flex flex-col md:flex-row items-center justify-between gap-3 p-2">
				<!-- Search Bar -->
				<div class="w-full md:w-1/2">
					<form class="flex items-center">
						<label for="simple-search" class="sr-only">Rechercher</label>
						<div class="relative w-full">
							<div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
								<svg class="w-5 h-5 text-gray-500" fill="currentColor" viewbox="0 0 20 20">
									<path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/>
								</svg>
							</div>
							<input type="text" id="simple-search" placeholder="Rechercher" required class="bg-gray-50 border border-gray-300 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full pl-10 p-2">
						</div>
					</form>
				</div>

				<!-- Add Button -->
				<div class="w-full md:w-auto flex flex-wrap md:flex-nowrap items-stretch md:items-center justify-end gap-2">
					<a href="{{ path('app_admin_rdv') }}">
						<button type="button" class="flex items-center text-pink-500 bg-primary-700 hover:bg-primary-800 focus:ring-4 focus:ring-primary-300 font-medium rounded-lg text-sm px-4 py-2">
							<svg class="h-4 w-4 mr-2" fill="currentColor" viewbox="0 0 20 20">
								<path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
							</svg>
							Ajouter un rendez-vous
						</button>
					</a>
				</div>
			</div>

			<!-- Rendez-vous Tables -->
			<div class="overflow-x-auto">
				{% for day, rendezvouses in rendezvousByDay %}
					<div class="date-block">
						<h2 class="text-lg font-bold mx-5 my-5">{{ day|date('d-m-Y') }}</h2>

						<table class="w-full text-sm text-left text-gray-500 mx-5 mb-10">
							<thead class="text-xs text-gray-700 uppercase bg-gray-50">
								<tr>
									{% set headers = ['Date Rdv', 'Créneau', 'Client', 'Prestation', 'Ajout', 'Statut', 'Image', 'Dernière modification', 'Actions'] %}
									{% for header in headers %}
										<th scope="col" class="px-4 py-3">{{ header }}</th>
									{% endfor %}
								</tr>
							</thead>
							<tbody>
								{% for rendezvous in rendezvouses %}
									<tr class="border-b">
										<td class="px-4 py-3">{{ rendezvous.day|date('d-m-Y') }}</td>
										<td class="px-4 py-3">{{ rendezvous.creneau }}</td>
										<td class="px-4 py-3">{{ rendezvous.user }}</td>
										<td class="px-4 py-3">{{ rendezvous.prestation }}</td>
										<td class="px-4 py-3">
											{% if rendezvous.supplement is empty %}Aucun
											{% else %}
												{{ rendezvous.supplement|map(s => s.title)|join(', ') }}
											{% endif %}
										</td>
										<td class="px-4 py-3">{{ rendezvous.status }}</td>
										<td class="px-4 py-3">
											{% if rendezvous.imageName %}
												<a href="{{ vich_uploader_asset(rendezvous, 'image') }}">
													<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 -960 960 960" width="24px" fill="#BE185D"><path d="M480-320q75 0 127.5-52.5T660-500q0-75-52.5-127.5T480-680q-75 0-127.5 52.5T300-500q0 75 52.5 127.5T480-320Zm0-72q-45 0-76.5-31.5T372-500q0-45 31.5-76.5T480-608q45 0 76.5 31.5T588-500q0 45-31.5 76.5T480-392Zm0 192q-146 0-266-81.5T40-500q54-137 174-218.5T480-800q146 0 266 81.5T920-500q-54 137-174 218.5T480-200Z"/></svg>
												</a>
												{% else %}Aucune image
											{% endif %}
										</td>
										<td class="px-4 py-3">{{ rendezvous.updatedAt|date('d-m-Y H:i:s') }}</td>
										<td class="px-4 py-3">
											<div class="flex items-center space-x-2">
												{% set isCancelled = rendezvous.status == 'Annulé' %}
												{% set isConfirmed = rendezvous.status == 'Rendez-vous confirmé' %}
												{% set actions = [
                      {'route': 'app_admin_rdv_edit', 'icon': 'report', 'title': 'Reporter'},
                      {'route': 'app_admin_rdv_cancel', 'icon': 'cancel', 'title': 'Annuler'},
                      {'route': 'app_admin_rdv_confirm', 'icon': 'check', 'title': 'Confirmer'}
                    ] %}
												{% set isCancelled = rendezvous.status == 'Annulé' %}
												{% set isConfirmed = rendezvous.status == 'Rendez-vous confirmé' %}
												{% set status = rendezvous.status|lower %}
												{% set onlyConfirmAllowed = status in ['paiement en attente', 'échec du paiement'] or status starts with 'tentative échou' %}

												{% for action in actions %}
													{% set isConfirmAction = action.route == 'app_admin_rdv_confirm' %}
													{% set disabled = isCancelled
        or (onlyConfirmAllowed and not isConfirmAction)
        or (isConfirmAction and isConfirmed) %}

													{% if not disabled %}
														<a href="{{ path(action.route, {'id': rendezvous.id}) }}" class="text-pink-600 hover:underline px-2" title="{{ action.title }}">
															{% if action.icon == 'report' %}
																<!-- Reporter SVG -->
																<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 -960 960 960" width="24px" fill="#BE185D"><path d="M200-80q-33 0-56.5-23.5T120-160v-560q0-33 23.5-56.5T200-800h40v-80h80v80h320v-80h80v80h40q33 0 56.5 23.5T840-720v200h-80v-40H200v400h280v80H200Zm360 0v-123l221-220q9-9 20-13t22-4q12 0 23 4.5t20 13.5l37 37q8 9 12.5 20t4.5 22q0 11-4 22.5T903-300L683-80H560Zm263-224 37-39-37-37-38 38 38 38Z"/></svg>
															{% elseif action.icon == 'cancel' %}
																<!-- Annuler SVG -->
																<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 -960 960 960" width="24px" fill="#BE185D"><path d="m376-320 104-104 104 104 56-56-104-104 104-104-56-56-104 104-104-104-56 56 104 104-104 104 56 56ZM160-160q-33 0-56.5-23.5T80-240v-480q0-33 23.5-56.5T160-800h640q33 0 56.5 23.5T880-720v480q0 33-23.5 56.5T800-160H160Z"/></svg>
															{% elseif action.icon == 'check' %}
																<!-- Confirmer SVG -->
																<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 -960 960 960" width="24px" fill="#BE185D"><path d="m424-312 282-282-56-56-226 226-114-114-56 56 170 170ZM200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h560q33 0 56.5 23.5T840-760v560q0 33-23.5 56.5T760-120H200Z"/></svg>
															{% endif %}
														</a>
													{% else %}
														<span class="opacity-50 cursor-not-allowed px-2" title="{{ action.title }}">
															{% if action.icon == 'report' %}
																<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 -960 960 960" width="24px" fill="#BE185D">
																	<path d="M200-80q-33 0-56.5-23.5T120-160v-560q0-33 23.5-56.5T200-800h40v-80h80v80h320v-80h80v80h40q33 0 56.5 23.5T840-720v200h-80v-40H200v400h280v80H200Zm360 0v-123l221-220q9-9 20-13t22-4q12 0 23 4.5t20 13.5l37 37q8 9 12.5 20t4.5 22q0 11-4 22.5T903-300L683-80H560Zm263-224 37-39-37-37-38 38 38 38Z"/>
																</svg>
															{% elseif action.icon == 'cancel' %}
																<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 -960 960 960" width="24px" fill="#BE185D">
																	<path d="m376-320 104-104 104 104 56-56-104-104 104-104-56-56-104 104-104-104-56 56 104 104-104 104 56 56ZM160-160q-33 0-56.5-23.5T80-240v-480q0-33 23.5-56.5T160-800h640q33 0 56.5 23.5T880-720v480q0 33-23.5 56.5T800-160H160Z"/>
																</svg>
															{% elseif action.icon == 'check' %}
																<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 -960 960 960" width="24px" fill="#BE185D">
																	<path d="m424-312 282-282-56-56-226 226-114-114-56 56 170 170ZM200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h560q33 0 56.5 23.5T840-760v560q0 33-23.5 56.5T760-120H200Z"/>
																</svg>
															{% endif %}
														</span>
													{% endif %}
												{% endfor %}

											</div>
										</td>
									</tr>
								{% endfor %}
							</tbody>
						</table>
					</div>
				{% endfor %}
			</div>
		</div>
	</div>
</section>

<script>
	document.addEventListener('DOMContentLoaded', () => {
const ITEMS_PER_PAGE = 3;
const blocks = Array.from(document.querySelectorAll('.date-block'));
const totalPages = Math.ceil(blocks.length / ITEMS_PER_PAGE);
let currentPage = 1;

function renderPagination() {
const nav = document.createElement('div');
nav.className = 'flex justify-center items-center space-x-4 mt-6 text-sm';

const prev = document.createElement('button');
prev.textContent = 'Précédent';
prev.className = 'px-3 py-1 rounded bg-gray-200 hover:bg-gray-300 disabled:opacity-50';
prev.disabled = currentPage === 1;

const next = document.createElement('button');
next.textContent = 'Suivant';
next.className = 'px-3 py-1 rounded bg-gray-200 hover:bg-gray-300 disabled:opacity-50';
next.disabled = currentPage === totalPages;

const info = document.createElement('span');
info.textContent = `Page ${currentPage} sur ${totalPages}`;

prev.addEventListener('click', () => {
if (currentPage > 1) {
currentPage--;
updateView();
}
});

next.addEventListener('click', () => {
if (currentPage < totalPages) {
currentPage++;
updateView();
}
});

nav.appendChild(prev);
nav.appendChild(info);
nav.appendChild(next);

document.querySelector('.date-block') ?. parentNode ?. appendChild(nav);
}

function updateView() {
blocks.forEach((block, index) => {
block.style.display = (index >= (currentPage - 1) * ITEMS_PER_PAGE && index < currentPage * ITEMS_PER_PAGE) ? '' : 'none';
});

// Mettre à jour pagination
const info = document.querySelector('span');
const [prev,, next] = document.querySelectorAll('button');

info.textContent = `Page ${currentPage} sur ${totalPages}`;
prev.disabled = currentPage === 1;
next.disabled = currentPage === totalPages;
}

renderPagination();
updateView();
});
</script>
