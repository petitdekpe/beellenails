{% block body %}

<div class="max-w-4xl">
{{ form_start(form, {'attr': {'id': 'monformulaire', 'class': 'space-y-6'}}) }}

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    
    <!-- Date Selection Card -->
    <div class="bg-gray-50 rounded-lg p-6">
      <div class="mb-4">
        <h3 class="text-lg font-medium text-gray-900 flex items-center">
          üìÖ Date du rendez-vous
        </h3>
        {% set hasErrors = form_errors(form.day)|length > 0 %}
        {% if hasErrors %}
          <div class="text-red-600 text-sm mt-1">
            {{ form_errors(form.day) }}
          </div>
        {% endif %}
      </div>
      <div class="space-y-4">
        {% set inputClass = hasErrors ? 'border-red-500' : 'border-gray-300' %}
        <input name="{{ field_name(form.day) }}" value="{{ field_value(form.day) }}" 
               placeholder="Cliquez pour choisir une date de rendez-vous" 
               class="bg-white {{ inputClass }} border text-gray-900 text-sm rounded-lg focus:ring-pink-500 focus:border-pink-500 block w-full p-3" 
               id="datepicker">
      </div>
    </div>

    <!-- Time Slot Selection Card -->
    <div class="bg-gray-50 rounded-lg p-6">
      <div class="mb-4">
        <h3 class="text-lg font-medium text-gray-900 flex items-center">
          üïí Cr√©neau horaire
        </h3>
        <p class="text-sm text-gray-600 mt-1">Choisir une date d'abord</p>
        {% set hasErrors = form_errors(form.creneau)|length > 0 %}
        {% if hasErrors %}
          <div class="text-red-600 text-sm mt-1">
            {{ form_errors(form.creneau) }}
          </div>
        {% endif %}
      </div>
      <div id="slots-container">
        {{ form_widget(form.creneau, {'attr': {'class': 'bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-pink-500 focus:border-pink-500 block w-full p-3'}}) }}
      </div>
    </div>

    <!-- Supplements Selection Card -->
    <div class="bg-gray-50 rounded-lg p-6">
      <div class="mb-4">
        <h3 class="text-lg font-medium text-gray-900 flex items-center">
          ‚ú® Suppl√©ments
        </h3>
        <p class="text-sm text-gray-600 mt-1">Options suppl√©mentaires disponibles</p>
      </div>
      <div class="space-y-3">
        {{ form_widget(form.supplement, {'attr': {'class': 'space-y-2'}}) }}
      </div>
    </div>

    <!-- Image Upload Card -->
    <div class="bg-gray-50 rounded-lg p-6">
      <div class="mb-4">
        <h3 class="text-lg font-medium text-gray-900 flex items-center">
          üì∑ {{ form_label(form.image, 'Photo de r√©f√©rence') }}
        </h3>
        <p class="text-sm text-gray-600 mt-1">{{ form_help(form.image) }}</p>
      </div>
      <div class="space-y-3">
        {{ form_widget(form.image, {'attr': {'class': 'block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-white focus:outline-none'}}) }}
      </div>
    </div>

  </div>

  <!-- Submit Button -->
  <div class="flex justify-center mt-8">
    <button type="submit" class="bg-pink-600 hover:bg-pink-700 text-white font-medium py-3 px-8 rounded-lg text-lg transition-colors duration-200">
      üìã Enregistrer le rendez-vous
    </button>
  </div>

  {{ form_widget(form._token) }}
{{ form_end(form, {'render_rest': false}) }}
</div>

{% endblock %}

{%  block javascripts %}

<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/fr.js"></script>
<script> 
    flatpickr("#datepicker", {
        enableTime: false,
        dateFormat: "Y-m-d",
        altInput: true,
        altFormat: "j F Y",
        inline: true,
        locale: "fr",
        minDate: "today",
        disable: [
        function(date) {
            // Retourne true pour d√©sactiver les samedis
            return (date.getDay() === 1);
        },
        function(date) {
            // Retourne true pour d√©sactiver les dimanches
            return (date.getDay() === 0);
        }
        ],
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        var datePicker = document.getElementById('datepicker');
        var slotsContainer = document.getElementById('slots-container');

        datePicker.addEventListener('change', function() {
            var selectedDate = datePicker.value;
            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/get-available-slots', true);
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            xhr.onreadystatechange = function() {
                if (xhr.readyState === XMLHttpRequest.DONE) {
                    if (xhr.status === 200) {
                        var slots = JSON.parse(xhr.responseText);
                        updateSlotsDropdown(slots);
                    } else {
                        console.error('Erreur lors de la r√©cup√©ration des cr√©neaux disponibles');
                    }
                }
            };
            xhr.send('date=' + selectedDate);
        });
        
        function updateSlotsDropdown(slots) {
        slotsContainer.innerHTML = ''; // Efface le contenu du conteneur

        // Si la liste de cr√©neaux est vide
        if (slots.length === 0) {
            var noSlotsParagraph = document.createElement('p');
            noSlotsParagraph.textContent = 'Aucun cr√©neau disponible pour cette date';
            noSlotsParagraph.className = 'text-red-600 bg-red-50 p-3 rounded-lg text-center';

            // Ajoute le paragraphe au conteneur
            slotsContainer.appendChild(noSlotsParagraph);
        } else {
            var selectElement = document.createElement('select'); // Cr√©e un √©l√©ment select
            selectElement.id = 'pre_rendezvous_creneau';
            selectElement.name = 'pre_rendezvous[creneau]'; // Ajoute le nom
            selectElement.className = 'bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-pink-500 focus:border-pink-500 block w-full p-3'; 

            // Add default option
            var defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.text = 'S√©lectionnez un cr√©neau';
            selectElement.appendChild(defaultOption);

            slots.forEach(function(slot) {
                var option = document.createElement('option');
                option.value = slot.id;
                option.text = slot.libelle;
                selectElement.appendChild(option);
            });

            // Ajoute le nouvel √©l√©ment select au conteneur
            slotsContainer.appendChild(selectElement);
        }
    }

    });
</script>

{% endblock %}

{% block stylesheets %}
<style>
/* Media queries pour ajuster Flatpickr avec Tailwind CSS */
.flatpickr-calendar {
    width: 100%;
    max-width: 320px;
    font-size: 14px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    border-radius: 8px;
}

/* Pour les √©crans moyens et plus grands */
@media (min-width: 640px) {
    .flatpickr-calendar {
        font-size: 16px;
    }
}

/* Styling pour les checkboxes de suppl√©ments */
input[type="checkbox"] {
    @apply rounded border-gray-300 text-pink-600 focus:ring-pink-500;
}
</style>
{% endblock %}